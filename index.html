<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essential Chord Progressions | The Worship Guitar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        roman: ['Montserrat', 'sans-serif'], 
                    },
                    colors: {
                        studio: {
                            900: 'rgb(34, 43, 28)', // Deep Forest Green
                            800: 'rgb(44, 55, 38)', // Slightly lighter green for cards
                            700: 'rgb(60, 75, 50)', // Border
                            accent: '#e6b05e', // Gold/Amber
                            secondary: '#f472b6', // Pink
                            mute: 'rgba(234, 227, 202, 0.6)' // Cream with opacity
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: rgb(34, 43, 28);
            color: rgb(234, 227, 202);
        }
        
        .glass-panel {
            background: rgba(34, 43, 28, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(234, 227, 202, 0.1);
        }

        .card-gradient {
            background: linear-gradient(180deg, rgb(44, 55, 38) 0%, rgb(25, 33, 20) 100%);
            border: 1px solid rgba(234, 227, 202, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        
        .card-gradient:hover {
            border-color: rgba(230, 176, 94, 0.4); /* Gold hover */
            transform: translateY(-2px);
        }

        .card-gradient.playing {
            border-color: #e6b05e;
            box-shadow: 0 0 20px rgba(230, 176, 94, 0.15);
            transform: translateY(-2px) scale(1.01);
        }

        /* Controls */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #e6b05e;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(230, 176, 94, 0.4);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: rgba(234, 227, 202, 0.2);
            border-radius: 2px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Dropdown styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e6b05e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            padding-right: 2rem;
        }

        /* Chord Grid - Single Line Layout */
        .chord-container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap; /* Forces single line */
            justify-content: space-between;
            gap: 8px;
            overflow: hidden; /* Prevents overflow if screen is very small */
        }
        
        .chord-item {
            flex: 1; /* Distribute space evenly */
            min-width: 0; /* Allow shrinking */
            max-width: 70px; /* Optimal size */
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar / Metronome Header -->
    <nav class="sticky top-0 z-50 glass-panel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="h-20 flex justify-between items-center gap-4">
                
                <!-- Logo -->
                <div class="flex items-center gap-3 shrink-0">
                    <div class="w-10 h-10 bg-studio-accent/10 border border-studio-accent/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="music-2" class="text-studio-accent w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight text-white leading-none">Essential <span class="text-studio-accent">Chord Progressions</span></h1>
                    </div>
                </div>

                <!-- Control Deck -->
                <div class="flex-1 max-w-xl mx-auto bg-black/20 rounded-full border border-white/5 px-6 py-2 flex items-center justify-between gap-6">
                    <div class="flex items-center gap-4 flex-1">
                        <button id="playBtn" onclick="toggleGlobalPlay()" class="w-10 h-10 rounded-full bg-studio-accent text-studio-900 flex items-center justify-center hover:bg-white transition shadow-[0_0_15px_rgba(230,176,94,0.2)] shrink-0">
                            <i data-lucide="play" class="fill-current w-4 h-4 ml-0.5"></i>
                        </button>
                        <div class="flex flex-col flex-1">
                            <div class="flex justify-between text-[10px] font-mono text-studio-accent mb-1 uppercase tracking-wider">
                                <span>Tempo</span>
                                <span id="bpmDisplay">120 BPM</span>
                            </div>
                            <input type="range" id="bpmSlider" min="40" max="220" value="120" oninput="updateBPM(this.value)" class="w-full cursor-pointer">
                        </div>
                    </div>
                    
                    <!-- Visual Beat Indicator -->
                    <div class="flex items-center gap-2 border-l border-white/10 pl-6">
                        <div id="beatLight" class="w-3 h-3 rounded-full bg-studio-700 transition-colors duration-75"></div>
                    </div>
                </div>

                <!-- Status -->
                <div class="hidden md:flex items-center gap-3 text-xs font-mono text-studio-mute">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-studio-accent shadow-[0_0_8px_rgba(230,176,94,0.4)]"></div>
                        <span>AUDIO ENGINE READY</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Worship Introduction Section -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-2">
        <h1 class="text-4xl md:text-5xl font-bold text-white font-roman mb-6 tracking-tight">
            The Architecture of <span class="text-studio-accent">Worship guitar</span>
        </h1>
        <p class="text-lg md:text-xl text-studio-mute max-w-4xl leading-relaxed font-sans font-light border-l-4 border-studio-accent pl-6">
            Chord progressions are more than just theory—they are the emotional landscape of a song. In <strong>Worship Music</strong>, these recurring patterns serve a higher purpose: bridging the gap between theological depth and musical expression. Mastering these 20 essential blueprints empowers you to lead with confidence, flow seamlessly between anthems, and create an unbroken atmosphere of praise where the focus remains on the message, not the mechanics.
        </p>
    </section>

    <!-- Filters -->
    <div class="border-b border-white/5 py-6 bg-studio-900 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="filterContainer">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="cardGrid">
            <!-- Cards injected via JS -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-studio-900 border-t border-white/5 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-studio-mute text-sm">Enrich Ministries &copy; 2026</p>
        </div>
    </footer>

    <script>
        // --- JS Color Constants to Match CSS Vars ---
        const COLORS = {
            primary: '#e6b05e', // Gold Accent
            muted: 'rgba(234, 227, 202, 0.4)', // Muted Cream
            text: 'rgb(234, 227, 202)', // Cream
            panel: 'rgba(234, 227, 202, 0.1)'
        };

        // --- DATA & STATE ---
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const STRING_FREQS = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]; 
        
        const BARRE_SHAPES = {
            'maj': { type: 'E', offsets: [0, 2, 2, 1, 0, 0] },
            'm':   { type: 'E', offsets: [0, 2, 2, 0, 0, 0] },
            '7':   { type: 'E', offsets: [0, 2, 0, 1, 0, 0] },
            'm7':  { type: 'E', offsets: [0, 2, 0, 0, 0, 0] },
            'maj7':{ type: 'E', offsets: [0, 'x', 1, 1, 0, 'x'] }
        };

        const SPECIFIC_SHAPES = {
            'C': ['x',3,2,0,1,0], 'C7': ['x',3,2,3,1,0], 'Cmaj7': ['x',3,2,0,0,0], 'Cm7': ['x',3,5,3,4,3],
            'A': ['x',0,2,2,2,0], 'Am': ['x',0,2,2,1,0], 'A7': ['x',0,2,0,2,0], 'Am7': ['x',0,2,0,1,0], 'Amaj7': ['x',0,2,1,2,0],
            'G': [3,2,0,0,0,3], 'G7': [3,2,0,0,0,1], 'Gm': [3,5,5,3,3,3], 'Gm7': [3,5,3,3,3,3], 'G7#5': [3,'x',3,4,4,'x'],
            'E': [0,2,2,1,0,0], 'Em': [0,2,2,0,0,0], 'E7': [0,2,0,1,0,0], 'Em7': [0,2,2,0,3,0],
            'D': ['x','x',0,2,3,2], 'Dm': ['x','x',0,2,3,1], 'D7': ['x','x',0,2,1,2], 'Dm7': ['x','x',0,2,1,1], 'Dmaj7': ['x','x',0,2,2,2], 'Dm7b5': ['x','x',0,1,1,1],
            'F': [1,3,3,2,1,1], 'Fm': [1,3,3,1,1,1], 'Fmaj7': ['x','x',3,2,1,0], 'F7': [1,3,1,2,1,1],
            'B7': ['x',2,1,2,0,2], 
            'Bb': ['x',1,3,3,3,1], 'Bbmaj7': ['x',1,3,2,3,1], 
            'Bm': ['x',2,4,4,3,2], 'F#m': [2,4,4,2,2,2], 'C#m': ['x',4,6,6,5,4]
        };

        let progressions = [
            { id: '01', title: 'The Pop Standard', formula: ['I', 'V', 'vi', 'IV'], desc: 'The "Axis of Awesome." Optimistic and endless.', chords: ['G', 'D', 'Em', 'C'], category: 'pop', key: 'G' },
            { id: '02', title: 'The 50s Ballad', formula: ['I', 'vi', 'IV', 'V'], desc: 'Stability to sweet melancholy to tension.', chords: ['C', 'Am', 'F', 'G'], category: 'pop', key: 'C' },
            { id: '03', title: 'The Folk Resolution', formula: ['I', 'IV', 'V', 'I'], desc: 'The absolute basic building block of harmony. Total resolution.', chords: ['D', 'G', 'A', 'D'], category: 'pop', key: 'D' },
            { id: '04', title: 'Mixolydian Rocker', formula: ['V', 'IV', 'I'], desc: 'Bluesier, harder rock resolve.', chords: ['A', 'G', 'D'], category: 'rock', key: 'D' },
            { id: '05', title: 'The Plagal "Amen"', formula: ['I', 'IV', 'I'], desc: 'Simple, gospel-rooted, and grounded. Often used to settle a verse.', chords: ['E', 'A', 'E'], category: 'rock', key: 'E' },
            { id: '06', title: 'The Sensitive Minor', formula: ['vi', 'IV', 'I', 'V'], desc: 'Starting on the minor flips the script.', chords: ['Am', 'F', 'C', 'G'], category: 'minor', key: 'C' },
            { id: '07', title: 'The Epic Cycle', formula: ['i', 'VI', 'III', 'VII'], desc: 'A minor key loop used in modern rock and EDM.', chords: ['Am', 'F', 'C', 'G'], category: 'minor', key: 'A' },
            { id: '08', title: 'The Andalusian', formula: ['i', 'bVII', 'bVI', 'V7'], desc: 'Flamenco descent.', chords: ['Am', 'G', 'F', 'E7'], category: 'minor', key: 'A' },
            { id: '09', title: 'The Minor Ballad', formula: ['i', 'iv', 'V7'], desc: 'Downward motion creates gravity and drama.', chords: ['Em', 'Am', 'B7'], category: 'minor', key: 'E' },
            { id: '10', title: 'The Iron Gallop', formula: ['i', 'bVI', 'bVII'], desc: 'A staple of heavy metal. Heroic and aggressive.', chords: ['Em', 'C', 'D'], category: 'rock', key: 'E' },
            { id: '11', title: '12-Bar Blues', formula: ['I7', 'IV7', 'I7', 'V7'], desc: 'Rock n\' Roll birthplace.', chords: ['A7', 'D7', 'A7', 'E7'], category: 'blues', key: 'A' },
            { id: '12', title: 'The Quick Change', formula: ['I7', 'IV7', 'I7', 'V7'], desc: 'Acceleration variation: Move to IV7 in Bar 2.', chords: ['A7', 'D7', 'A7', 'E7'], category: 'blues', key: 'A' },
            { id: '13', title: 'AC/DC Rock', formula: ['I', 'bVII', 'IV'], desc: 'Rebellious flat 7 tone.', chords: ['E', 'D', 'A'], category: 'rock', key: 'E' },
            { id: '14', title: 'The Funky Vamp', formula: ['i7', 'IV7'], desc: 'A two-chord Dorian loop. Used in funk and jam bands.', chords: ['Am7', 'D7'], category: 'blues', key: 'A' },
            { id: '15', title: 'The Riff Rocker', formula: ['I', 'bIII', 'IV'], desc: 'Uses the flat 3 for a heavy, bluesy lift.', chords: ['E', 'G', 'A'], category: 'rock', key: 'E' },
            { id: '16', title: 'Major ii-V-I', formula: ['ii7', 'V7', 'Imaj7'], desc: 'Jazz gold standard.', chords: ['Dm7', 'G7', 'Cmaj7'], category: 'jazz', key: 'C' },
            { id: '17', title: 'Soulful Turnaround', formula: ['Imaj7', 'vi7', 'ii7', 'V7'], desc: 'The foundation of Rhythm Changes and 1950s standards.', chords: ['Bbmaj7', 'Gm7', 'Cm7', 'F7'], category: 'jazz', key: 'Bb' },
            { id: '18', title: 'The Minor ii-V-i', formula: ['ii7b5', 'V7alt', 'im7'], desc: 'The dark, noir-film cousin of the Major ii-V-I.', chords: ['Dm7b5', 'G7#5', 'Cm7'], category: 'jazz', key: 'C' },
            { id: '19', title: 'Sentimental Turn', formula: ['I', 'I7', 'IV', 'iv'], desc: 'Emotional Major to Minor shift.', chords: ['C', 'C7', 'F', 'Fm'], category: 'minor', key: 'C' },
            { id: '20', title: 'Picardy Third', formula: ['i', 'iv', 'V', 'I'], desc: 'Ending minor song on Major.', chords: ['Am', 'Dm', 'E', 'A'], category: 'minor', key: 'A' }
        ];

        let activeProgressions = JSON.parse(JSON.stringify(progressions));
        activeProgressions.forEach(p => p.currentKey = p.key);

        // --- AUDIO ENGINE ---
        let audioCtx, masterGain, reverbNode, ampSimNode;
        let isPlaying = false;
        let activeProgressionId = null;
        let beatCount = 0;
        let bpm = 120;
        let nextNoteTime = 0.0;
        let timerID = null;
        let lookahead = 25.0;
        let scheduleAheadTime = 0.1;

        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function createImpulseResponse(duration, decay, reverse) {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * duration;
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = reverse ? length - i : i;
                left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
            }
            return impulse;
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.6; 
                const distortion = audioCtx.createWaveShaper();
                distortion.curve = makeDistortionCurve(50); 
                distortion.oversample = '4x';
                const bassCut = audioCtx.createBiquadFilter();
                bassCut.type = 'highpass';
                bassCut.frequency.value = 80;
                const trebCut = audioCtx.createBiquadFilter();
                trebCut.type = 'lowpass';
                trebCut.frequency.value = 6000;
                reverbNode = audioCtx.createConvolver();
                reverbNode.buffer = createImpulseResponse(1.5, 3.0, false); 
                const reverbGain = audioCtx.createGain();
                reverbGain.gain.value = 0.3; 
                const dryGain = audioCtx.createGain();
                dryGain.gain.value = 0.8;
                ampSimNode = audioCtx.createGain();
                ampSimNode.connect(distortion);
                distortion.connect(bassCut);
                bassCut.connect(trebCut);
                trebCut.connect(dryGain);
                trebCut.connect(reverbNode);
                reverbNode.connect(reverbGain);
                dryGain.connect(masterGain);
                reverbGain.connect(masterGain);
                masterGain.connect(audioCtx.destination);
            }
        }

        function getVoicingFretArray(chordName) {
             const { root, suffix } = parseChord(chordName);
             let positions = SPECIFIC_SHAPES[chordName];
             if (positions) return positions;

             let type = 'maj';
             if (suffix.includes('m7')) type = 'm7';
             else if (suffix.includes('m')) type = 'm';
             else if (suffix.includes('7')) type = '7';
             else if (suffix.includes('maj7')) type = 'maj7';

             const rootNoteIndex = NOTES.indexOf(root);
             const E_Index = NOTES.indexOf('E');
             let fret = rootNoteIndex - E_Index;
             if (fret < 0) fret += 12; 
             if (fret === 0) fret = 12;

             const shape = BARRE_SHAPES[type].offsets;
             return shape.map(p => {
                 if (p === 'x') return 'x';
                 if (p === 0) return fret;
                 return fret + p;
             });
        }

        function playGuitarChord(chordName, time) {
            const frets = getVoicingFretArray(chordName);
            const velocity = 0.8 + Math.random() * 0.2; 

            frets.forEach((fret, stringIndex) => {
                if (fret === 'x') return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                const freq = STRING_FREQS[stringIndex] * Math.pow(2, fret / 12);
                
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                filter.type = 'lowpass';
                filter.Q.value = 3; 
                const brightness = 4000 + (velocity * 2000); 
                filter.frequency.setValueAtTime(brightness, time);
                filter.frequency.exponentialRampToValueAtTime(100, time + 0.2); 
                const stagger = 0.02 + (Math.random() * 0.01); 
                const strumTime = time + (stringIndex * stagger);
                gain.gain.setValueAtTime(0, strumTime);
                gain.gain.linearRampToValueAtTime(0.3 * velocity, strumTime + 0.01); 
                gain.gain.exponentialRampToValueAtTime(0.001, strumTime + 2.0); 

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ampSimNode); 
                osc.start(strumTime);
                osc.stop(strumTime + 2.0);
            });
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
            beatCount++;
        }

        function scheduleNote(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = (beatCount % 4 === 0) ? 1200 : 800; 
            osc.type = 'triangle'; 
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + 0.05);

            if (activeProgressionId) {
                const prog = activeProgressions.find(p => p.id === activeProgressionId);
                if (prog) {
                    const chordIndex = Math.floor(beatCount / 4) % prog.chords.length;
                    if (beatCount % 4 === 0) {
                        playGuitarChord(prog.chords[chordIndex], time);
                    }
                }
            }

            const light = document.getElementById('beatLight');
            setTimeout(() => {
                const isDownbeat = (beatCount % 4 === 0);
                light.className = isDownbeat 
                    ? 'w-3 h-3 rounded-full bg-studio-accent shadow-[0_0_10px_#e6b05e] transition-colors duration-75'
                    : 'w-3 h-3 rounded-full bg-studio-700 shadow-[0_0_5px_rgba(230,176,94,0.2)] transition-colors duration-75';
                
                setTimeout(() => {
                    light.className = 'w-3 h-3 rounded-full bg-studio-700 transition-colors duration-75';
                }, 100);
            }, (time - audioCtx.currentTime) * 1000);
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(nextNoteTime);
                nextNote();
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        function toggleGlobalPlay() {
            togglePlayback(null);
        }

        function togglePlayback(progressionId) {
            initAudio();
            const btn = document.getElementById('playBtn');

            if (isPlaying && activeProgressionId === progressionId) {
                window.clearTimeout(timerID);
                isPlaying = false;
                activeProgressionId = null;
                beatCount = 0;
                btn.innerHTML = `<i data-lucide="play" class="fill-current w-4 h-4 ml-0.5"></i>`;
                btn.classList.remove('bg-studio-accent', 'text-studio-900');
                btn.classList.add('bg-studio-accent', 'text-studio-900');
                
                document.querySelectorAll('.card-gradient').forEach(c => c.classList.remove('playing'));
                document.querySelectorAll('.play-icon').forEach(i => i.setAttribute('data-lucide', 'headphones'));
            } else {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                if (!isPlaying) {
                    nextNoteTime = audioCtx.currentTime + 0.05;
                    scheduler();
                    isPlaying = true;
                    btn.innerHTML = `<i data-lucide="square" class="fill-current w-4 h-4"></i>`;
                }
                activeProgressionId = progressionId;
                document.querySelectorAll('.card-gradient').forEach(c => c.classList.remove('playing'));
                document.querySelectorAll('.play-icon').forEach(i => i.setAttribute('data-lucide', 'headphones'));
                if (progressionId) {
                    const card = document.getElementById(`card-${progressionId}`);
                    if (card) {
                        card.classList.add('playing');
                        const icon = card.querySelector('.play-icon');
                        if(icon) icon.setAttribute('data-lucide', 'loader');
                    }
                }
            }
            lucide.createIcons();
        }

        function updateBPM(val) {
            bpm = val;
            document.getElementById('bpmDisplay').innerText = `${val} BPM`;
        }

        function parseChord(chordName) {
            const match = chordName.match(/^([A-G][#b]?)(.*)$/);
            if (!match) return { root: 'C', suffix: '', original: chordName };
            return { root: match[1], suffix: match[2], original: chordName };
        }

        function transposeChord(chordName, semitones) {
            const { root, suffix } = parseChord(chordName);
            let index = NOTES.indexOf(root);
            if (index === -1) {
                const flatMap = {'Db':'C#', 'Eb':'D#', 'Gb':'F#', 'Ab':'G#', 'Bb':'A#'};
                if (flatMap[root]) index = NOTES.indexOf(flatMap[root]);
                else return chordName; 
            }
            let newIndex = (index + semitones) % 12;
            if (newIndex < 0) newIndex += 12;
            return NOTES[newIndex] + suffix;
        }

        function generateSVG(chordName) {
            const positions = getVoicingFretArray(chordName);
            let startFret = 1;
            const numericalFrets = positions.filter(p => p !== 'x');
            const minFret = Math.min(...numericalFrets);
            let visualPositions = positions;
            if (minFret > 2) {
                startFret = minFret;
                visualPositions = positions.map(p => (p === 'x' ? 'x' : p - startFret + 1));
            }
            const width = 60;
            const height = 80;
            const mx = 6; const my = 12;
            const stringSpace = (width - 2*mx) / 5;
            const fretSpace = (height - my - 10) / 5;
            let svg = `<svg viewBox="0 0 ${width} ${height}" class="w-full h-auto">`;
            for(let i=0; i<6; i++) {
                // Strings color: Increased thickness (1.2) and opacity (0.5)
                svg += `<line x1="${mx + i*stringSpace}" y1="${my}" x2="${mx + i*stringSpace}" y2="${height-10}" stroke="${COLORS.text}" stroke-opacity="0.5" stroke-width="1.2"/>`;
            }
            for(let i=0; i<=5; i++) {
                // Frets: Increased thickness (1.2 normal, 3.0 nut) and opacity
                let sw = i===0 ? (startFret===1 ? 3.0 : 1.2) : 1.2;
                let stroke = COLORS.text;
                let opacity = i===0 && startFret===1 ? '0.8' : '0.5';
                svg += `<line x1="${mx}" y1="${my + i*fretSpace}" x2="${width-mx}" y2="${my + i*fretSpace}" stroke="${stroke}" stroke-width="${sw}" stroke-opacity="${opacity}"/>`;
            }
            visualPositions.forEach((pos, strIdx) => {
                const x = mx + strIdx * stringSpace;
                if (pos === 'x') {
                    // Mute: Bolder
                    svg += `<text x="${x}" y="${my-2}" font-family="sans-serif" font-size="7" fill="${COLORS.text}" fill-opacity="0.7" text-anchor="middle" font-weight="bold">×</text>`;
                } else if (pos === 0 && startFret === 1) {
                    // Open: Thicker stroke
                    svg += `<circle cx="${x}" cy="${my-3}" r="2" stroke="${COLORS.primary}" stroke-width="1.5" fill="none"/>`;
                } else {
                    // Finger: Larger radius
                    const y = my + (pos * fretSpace) - (fretSpace/2);
                    svg += `<circle cx="${x}" cy="${y}" r="3.2" fill="${COLORS.primary}"/>`;
                }
            });
            if (startFret > 1) {
                svg += `<text x="0" y="${my + fretSpace - 2}" font-family="sans-serif" font-size="7" fill="${COLORS.text}" fill-opacity="0.9" font-weight="bold">${startFret}</text>`;
            }
            svg += `<text x="${width/2}" y="${height-1}" font-family="sans-serif" font-size="9" fill="${COLORS.text}" fill-opacity="1" text-anchor="middle" font-weight="800">${chordName}</text>`;
            svg += `</svg>`;
            return svg;
        }

        function render(category = 'all') {
            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';
            
            const filtered = category === 'all' 
                ? activeProgressions 
                : activeProgressions.filter(p => p.category === category);

            filtered.forEach((p) => {
                const chordSVGs = p.chords.map(c => `<div class="chord-item">${generateSVG(c)}</div>`).join('');
                
                const keyOptions = NOTES.map(note => {
                    return `<option value="${note}" ${note === p.currentKey ? 'selected' : ''}>Key: ${note}</option>`;
                }).join('');

                const card = document.createElement('div');
                card.className = 'card-gradient rounded-xl overflow-hidden flex flex-col relative group';
                card.id = `card-${p.id}`; 
                card.innerHTML = `
                    <div class="p-5 flex-grow">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-bold text-studio-accent uppercase tracking-widest border border-studio-accent/20 px-2 py-0.5 rounded bg-studio-accent/10">${p.category}</span>
                            <div class="relative">
                                <select onchange="setKey('${p.id}', this.value)" class="bg-studio-800 text-xs font-mono text-white border border-white/10 rounded px-2 py-1 pr-6 focus:border-studio-accent outline-none cursor-pointer hover:bg-studio-700 transition">
                                    ${keyOptions}
                                </select>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-white mb-4 leading-tight">${p.title}</h3>

                        <!-- Diagram Box with Horizontal Flex -->
                        <div class="bg-black/20 rounded-lg p-3 border border-white/5 mb-4 relative">
                             <div class="chord-container">
                                ${chordSVGs}
                            </div>
                        </div>

                        <div class="text-xs text-studio-mute font-mono mb-2 uppercase">Intervals</div>
                        <div class="font-roman text-sm font-bold text-white bg-white/5 rounded px-2 py-1 inline-block border border-white/5 mb-3 tracking-wide">
                            ${p.formula.join(' - ')}
                        </div>
                        <p class="text-sm text-studio-mute leading-relaxed">${p.desc}</p>
                    </div>

                    <div class="mt-auto p-4 border-t border-white/5 bg-black/20 flex justify-between items-center">
                        <button onclick="togglePlayback('${p.id}')" class="flex items-center gap-2 text-xs font-bold text-white hover:text-studio-accent transition group">
                            <div class="w-8 h-8 rounded-full bg-studio-700 group-hover:bg-white/10 flex items-center justify-center border border-white/5">
                                <i data-lucide="headphones" class="play-icon w-4 h-4 text-studio-accent"></i>
                            </div>
                            <span>LISTEN</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });

            const categories = ['all', 'pop', 'rock', 'blues', 'minor', 'jazz'];
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.innerHTML = categories.map(c => `
                <button onclick="render('${c}')" class="${c === category ? 'bg-studio-accent text-studio-900 border-studio-accent' : 'bg-studio-800 text-studio-mute border-white/10'} px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider border transition-all whitespace-nowrap hover:bg-studio-700">
                    ${c}
                </button>
            `).join('');
            
            lucide.createIcons();
        }

        function setKey(id, targetKey) {
            const originalProg = progressions.find(p => p.id === id);
            const activeIndex = activeProgressions.findIndex(p => p.id === id);
            if (!originalProg || activeIndex === -1) return;

            const originalKeyIndex = NOTES.indexOf(originalProg.key);
            const targetKeyIndex = NOTES.indexOf(targetKey);
            let semitones = targetKeyIndex - originalKeyIndex;

            activeProgressions[activeIndex].chords = originalProg.chords.map(c => transposeChord(c, semitones));
            activeProgressions[activeIndex].currentKey = targetKey;
            
            const activeBtn = document.querySelector('#filterContainer .bg-studio-accent');
            const currentFilter = activeBtn ? activeBtn.innerText.toLowerCase() : 'all';
            render(currentFilter);
        }

        render();
    </script>
</body>
</html>
